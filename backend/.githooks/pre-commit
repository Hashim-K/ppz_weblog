#!/bin/bash

# Git pre-commit hook script for Paparazzi UAV Log Parser Backend
# This script runs checks before a commit is made.
# It will auto-format with Black and then run other checks.
# If any check (after formatting) fails, the commit will be aborted.

# Exit immediately if a command exits with a non-zero status.
set -e

echo "ğŸ Paparazzi WebLog Backend - Pre-commit checks..."
echo "=================================================="

# 1. Format Python code with Black and stage changes
echo "ğŸ¨ Formatting Python code with Black (auto-fixing)..."
if command -v black &> /dev/null; then
    black . --line-length=88
    echo "âœ¨ Python files formatted by Black (if any)."
else
    echo "âš ï¸ Black not found, skipping formatting. Install with: pip install black"
fi

# Add any files modified by Black
echo "â• Staging automatic formatting changes..."
git add .
echo "âœ… Black formatting applied and changes staged."
echo "=================================================="

# 2. Sort imports with isort
echo "ğŸ“¦ Sorting imports with isort..."
if command -v isort &> /dev/null; then
    isort . --profile black
    git add .
    echo "âœ… Imports sorted successfully."
else
    echo "âš ï¸ isort not found, skipping import sorting. Install with: pip install isort"
fi
echo "=================================================="

# 3. Lint code with Flake8
echo "ğŸ” Linting Python code with Flake8..."
if command -v flake8 &> /dev/null; then
    if ! flake8 . --max-line-length=88 --extend-ignore=E203,W503; then
        echo "âŒ Flake8 checks failed. Please fix the linting errors."
        echo "ğŸ’¡ Common issues:"
        echo "   - Line too long (use Black to auto-format)"
        echo "   - Unused imports"
        echo "   - Undefined variables"
        exit 1
    fi
    echo "âœ… Flake8 checks passed."
else
    echo "âš ï¸ Flake8 not found, skipping linting. Install with: pip install flake8"
fi
echo "=================================================="

# 4. Type checking with mypy
echo "ğŸ§ Checking types with mypy..."
if command -v mypy &> /dev/null; then
    if ! mypy . --ignore-missing-imports; then
        echo "âŒ mypy type checking failed. Please fix the type errors."
        echo "ğŸ’¡ Consider adding type hints to improve code quality"
        exit 1
    fi
    echo "âœ… mypy type checking passed."
else
    echo "âš ï¸ mypy not found, skipping type checking. Install with: pip install mypy"
fi
echo "=================================================="

# 5. Run tests if they exist
echo "ğŸ§ª Running tests..."
if [ -f "pytest.ini" ] || [ -f "pyproject.toml" ] || [ -d "tests" ]; then
    if command -v pytest &> /dev/null; then
        if ! pytest -v; then
            echo "âŒ Tests failed. Please fix the failing tests."
            exit 1
        fi
        echo "âœ… All tests passed."
    else
        echo "âš ï¸ pytest not found, skipping tests. Install with: pip install pytest"
    fi
else
    echo "âš ï¸ No test configuration found, skipping tests."
fi
echo "=================================================="

# 6. Check if FastAPI server can start
echo "ğŸš€ Checking if FastAPI server can start..."
if python -c "from main import app; print('âœ… FastAPI app imports successfully')" 2>/dev/null; then
    echo "âœ… FastAPI server can start successfully."
else
    echo "âŒ FastAPI server failed to start. Please check for import errors."
    exit 1
fi
echo "=================================================="

echo "ğŸ‰ All pre-commit checks passed! Proceeding with commit."
echo "ğŸ”§ Backend ready for deployment."
exit 0 # Explicitly exit with 0 on success
