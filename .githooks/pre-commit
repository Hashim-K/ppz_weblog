#!/bin/bash

# Git pre-commit hook for Paparazzi UAV Log Parser
# This script runs comprehensive checks for both frontend and backend
# before allowing a commit to proceed.

set -e

echo "ğŸš€ Paparazzi UAV Log Parser - Pre-commit checks..."
echo "=================================================="

# Get the root directory of the repository
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Function to check if directory exists and has files
check_directory() {
    if [ -d "$1" ] && [ "$(ls -A "$1" 2>/dev/null)" ]; then
        return 0
    else
        return 1
    fi
}

# Backend checks
if check_directory "backend"; then
    echo ""
    echo "ğŸ Backend Checks"
    echo "=================="
    cd backend

    # Check if Python tools are available
    echo "ğŸ”§ Checking Python tools availability..."
    if ! command -v python &> /dev/null; then
        echo "âŒ Python not found. Please install Python 3.11+."
        exit 1
    fi

    # Format Python code with Black
    echo "ğŸ¨ Formatting Python code with Black..."
    if command -v black &> /dev/null; then
        black . --line-length=88
        echo "âœ¨ Python files formatted by Black."
    else
        echo "âš ï¸ Black not found. Install with: pip install black"
        echo "âŒ Code formatting check failed."
        exit 1
    fi

    # Remove unused imports and variables with autoflake
    echo "ğŸ§¹ Removing unused imports and variables with autoflake..."
    if command -v autoflake &> /dev/null; then
        autoflake --in-place --remove-all-unused-imports --remove-unused-variables --recursive .
        echo "âœ… Unused imports and variables removed."
    else
        echo "âš ï¸ autoflake not found. Install with: pip install autoflake"
    fi

    # Sort imports with isort
    echo "ğŸ“¦ Sorting imports with isort..."
    if command -v isort &> /dev/null; then
        isort . --profile black
        echo "âœ… Imports sorted successfully."
    else
        echo "âš ï¸ isort not found. Install with: pip install isort"
        echo "âŒ Import sorting check failed."
        exit 1
    fi

    # Add any files modified by Black/isort
    echo "â• Staging Python formatting changes..."
    git add .
    echo "âœ… Python formatting changes staged."

    # Lint with Flake8
    echo "ğŸ” Linting Python code with Flake8..."
    if command -v flake8 &> /dev/null; then
        if ! flake8 . --max-line-length=88 --extend-ignore=E203,W503; then
            echo "âŒ Flake8 checks failed. Please fix the linting errors."
            echo "ğŸ’¡ Common issues:"
            echo "   - Unused imports or variables"
            echo "   - Line too long (use Black to auto-format)"
            echo "   - Missing whitespace around operators"
            exit 1
        fi
        echo "âœ… Flake8 checks passed."
    else
        echo "âš ï¸ Flake8 not found. Install with: pip install flake8"
    fi

    # Type checking with mypy
    echo "ğŸ§ Checking types with mypy..."
    if command -v mypy &> /dev/null; then
        if ! (mypy . --ignore-missing-imports --explicit-package-bases); then
            echo "âŒ mypy type checking failed. Please fix the type errors."
            echo "ğŸ’¡ Consider adding type hints to improve code quality."
            exit 1
        fi
        echo "âœ… mypy type checking passed."
    else
        echo "âš ï¸ mypy not found. Install with: pip install mypy"
    fi

    # Test FastAPI import
    echo "ğŸš€ Testing FastAPI application import..."
    if ! python -c "from main import app; print('FastAPI app imports successfully')" 2>/dev/null; then
        echo "âŒ FastAPI app import failed. Please check for import errors."
        exit 1
    fi
    echo "âœ… FastAPI app imports successfully."

    # Run tests if they exist
    echo "ğŸ§ª Running tests..."
    if [ -f "pytest.ini" ] || [ -f "pyproject.toml" ] || [ -d "tests" ]; then
        if command -v pytest &> /dev/null; then
            if ! pytest -v; then
                echo "âŒ Tests failed. Please fix the failing tests."
                exit 1
            fi
            echo "âœ… All tests passed."
        else
            echo "âš ï¸ pytest not found. Install with: pip install pytest"
        fi
    else
        echo "âš ï¸ No test configuration found, skipping tests."
    fi

    cd "$REPO_ROOT"
    echo "âœ… Backend checks completed successfully."
else
    echo "âš ï¸ Backend directory not found, skipping backend checks."
fi

# Frontend checks
if check_directory "frontend"; then
    echo ""
    echo "ğŸŒ Frontend Checks"
    echo "==================="
    cd frontend

    # Check if Bun is available
    echo "ğŸ”§ Checking frontend tools availability..."
    if ! command -v bun &> /dev/null; then
        echo "âŒ Bun not found. Please install Bun: https://bun.sh/"
        exit 1
    fi

    # Install dependencies
    echo "ğŸ“¦ Installing dependencies..."
    if [ -f "bun.lock" ]; then
        bun install --frozen-lockfile
    else
        echo "âš ï¸ bun.lock not found, running bun install..."
        bun install
    fi
    echo "âœ… Dependencies installed."

    # Format code with Prettier
    echo "ğŸ¨ Formatting code with Prettier..."
    if bunx prettier --write . --ignore-unknown; then
        echo "âœ¨ Files formatted by Prettier."
        # Add any files modified by Prettier
        echo "â• Staging Prettier formatting changes..."
        git add .
        echo "âœ… Prettier formatting changes staged."
    else
        echo "âŒ Prettier formatting failed."
        exit 1
    fi

    # Lint with ESLint
    echo "ğŸ” Linting with ESLint..."
    if ! bun run lint; then
        echo "âŒ ESLint checks failed. Please fix the linting errors."
        echo "ğŸ’¡ Try running: bun run lint --fix"
        exit 1
    fi
    echo "âœ… ESLint checks passed."

    # Type checking with TypeScript
    echo "ğŸ§ Checking TypeScript types..."
    if ! bun tsc --noEmit; then
        echo "âŒ TypeScript type checking failed. Please fix the type errors."
        exit 1
    fi
    echo "âœ… TypeScript type checking passed."

    # Build application
    echo "ğŸ› ï¸ Building Next.js application..."
    if ! bun run build; then
        echo "âŒ Next.js build failed. Please fix the build errors."
        echo "ğŸ’¡ Common issues:"
        echo "   - Check for unused imports or variables"
        echo "   - Verify all components are properly exported"
        echo "   - Check for missing dependencies"
        exit 1
    fi
    echo "âœ… Next.js build successful."

    cd "$REPO_ROOT"
    echo "âœ… Frontend checks completed successfully."
else
    echo "âš ï¸ Frontend directory not found, skipping frontend checks."
fi

echo ""
echo "ğŸ‰ All pre-commit checks passed! Proceeding with commit."
echo "ğŸš€ Code is ready for deployment."
echo "=================================================="

exit 0
